<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>新聞人名擷取工具</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    h1 { font-size: 1.5em; }
    #progress-container { margin: 1em 0; }
    #results { white-space: pre; background: #f9f9f9; padding: 1em; border: 1px solid #ccc; }
    #downloadBtn { margin-top: 1em; padding: 0.5em 1em; }
  </style>
</head>
<body>

<h1>新聞人名擷取工具</h1>

<button id="startBtn">開始擷取</button>
<div id="progress-container" style="display:none;">
  <label for="progress">處理進度：</label>
  <progress id="progress" value="0" max="100" style="width:300px;"></progress>
  <span id="progress-text">0%</span>
</div>
<pre id="results" placeholder="結果將顯示於此..."></pre>
<button id="downloadBtn" style="display:none;">下載結果.txt</button>

<script>
// RSS Feed URLs 與來源名稱對照
const feeds = [
  { url: 'https://feeds.feedburner.com/ettoday/realtime', sourceName: 'ETtoday' },
  { url: 'https://news.ltn.com.tw/rss/all.xml', sourceName: '自由時報' }
];

// 女性主題關鍵詞列表（含部分同義詞）
const femaleKeywords = ['女警', '警花', '美女', '藝人', '啦啦隊', '模特兒', '女政治人物', '網紅'];

// 常見中文姓氏列表（節選常用百家姓）
const surnames = [
  "趙","錢","孫","李","周","吳","鄭","王","馮","陳","楊","朱","林","何","郭","高","羅","馬","胡","施",
  "任","柳","張","孔","曹","嚴","華","金","魏","陶","姜","謝","韓","唐","馮","于","董","蕭","程","曹",
  "袁","蕭","鄧","許","傅","沈","曾","彭","呂","蘇","盧","蔣","蔡","余","杜","葉","程","蘇","黃","汪",
  "田","戴","宋","許","梁","趙","鄭","謝","崔","章","劉","鄧","庄","石","姚","賀","顧","毛","史","萬",
  "錢","潘","胡","魏","任","童","方","白","邱","孟","熊","秦","楊","江","尹","薛","闕","尤","巫","花"
  // ...（可酌情擴充）
];

// 啟動按鈕事件
document.getElementById('startBtn').addEventListener('click', () => {
  document.getElementById('startBtn').disabled = true;
  document.getElementById('progress-container').style.display = 'block';
  fetchAllFeeds();
});

async function fetchAllFeeds() {
  let allItems = [];
  // 逐一抓取每個RSS來源
  for (const feed of feeds) {
    try {
      const res = await fetch(feed.url);
      const xmlText = await res.text();
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmlText, "text/xml");
      const items = xmlDoc.querySelectorAll("item, entry");
      // 將每篇新聞節點及來源資訊存入 allItems 陣列
      items.forEach(item => {
        allItems.push({ source: feed.sourceName, node: item });
      });
    } catch (e) {
      console.error(`無法取得RSS: ${feed.url}`, e);
    }
  }
  // 設定進度條最大值
  const progress = document.getElementById('progress');
  progress.max = allItems.length;
  // 處理所有新聞項目
  let resultsData = [];
  for (let i = 0; i < allItems.length; i++) {
    const { source, node } = allItems[i];
    const resultLines = processNewsItem(node, source);
    // 將處理結果加入清單
    resultsData.push(...resultLines);
    // 即時更新頁面結果顯示
    if (resultLines.length > 0) {
      appendResults(resultLines);
    }
    // 更新進度條
    progress.value = i + 1;
    const percent = Math.floor(((i + 1) / allItems.length) * 100);
    document.getElementById('progress-text').innerText = percent + '%';
  }
  // 顯示下載按鈕並綁定下載事件
  document.getElementById('downloadBtn').style.display = 'inline-block';
  document.getElementById('downloadBtn').addEventListener('click', () => {
    downloadResults(resultsData);
  });
}

// 處理單篇新聞項目：擷取人名並形成結果行
function processNewsItem(itemNode, sourceName) {
  let results = [];
  const title = itemNode.querySelector("title")?.textContent || "";
  const description = itemNode.querySelector("description, content")?.textContent || "";
  // 合併標題和描述作為全文（去除HTML標籤）
  const contentText = stripHtml(`${title}。${description}`);
  const sentences = contentText.split(/[\n。！？!?]/);  // 按句號、問號、驚嘆號等分句
  
  // 先檢查該新聞是否包含女性主題關鍵字，並決定標籤
  let tag = "無標籤";
  for (let kw of femaleKeywords) {
    if (contentText.includes(kw)) {
      // 關鍵詞優先級判斷：避免「美女」蓋過其他身份詞
      if (kw === "美女") {
        // 若還有其他關鍵詞則稍後再決定，這裡暫不立刻賦值
        tag = tag; 
      } else if (kw === "警花") {
        // 將警花同義視作女警
        tag = "女警";
        break;
      } else {
        tag = kw;
        break;
      }
    }
  }
  // 特殊處理：若僅匹配到"美女"且沒有其他標籤，則才標記為"美女"
  if (tag === "無標籤" && contentText.includes("美女")) {
    tag = "美女";
  }
  
  // 在文本中查找所有可能的人名
  const namePattern = new RegExp(`(${surnames.join("|")})([\\p{Han}]{1,2})`, "ug");
  let match;
  let foundNames = new Set();
  while ((match = namePattern.exec(contentText)) !== null) {
    const fullName = match[0];
    // 濾除已收集的重複姓名
    if (foundNames.has(fullName)) continue;
    // 濾除姓名包含停用字詞（如職稱）或格式不符的
    if (/記者$/.test(fullName) || /發言人$/.test(fullName)) {
      continue; // 名字結尾是記者/發言人（如"張記者"）- 跳過
    }
    if (/^記者/.test(fullName) || /^發言人/.test(fullName)) {
      continue; // 名字開頭是記者/發言人（如"記者張三"）- 跳過
    }
    if (fullName.length < 2 || fullName.length > 3) {
      continue; // 不符合2-3字長度
    }
    if (fullName[1] === "男" || fullName[1] === "女") {
      continue; // 排除「X男」「Y女」這類代稱
    }
    // 通過以上檢查，視作有效姓名
    foundNames.add(fullName);
    // 尋找此姓名所在句子
    let roleDesc = "";
    for (let sent of sentences) {
      if (sent.includes(fullName)) {
        // 去除前後空白
        sent = sent.trim();
        // 找到姓名在句子中的位置
        const idx = sent.indexOf(fullName);
        if (idx > -1) {
          // 提取姓名前面的描述部分
          roleDesc = sent.substring(0, idx);
          // 如果描述過短或不存在，則使用整句作描述
          if (roleDesc.length < 2) {
            roleDesc = sent;
          }
        }
        break;
      }
    }
    if (roleDesc === "") {
      // 若找不到句子（fallback，用標題或者描述首句）
      roleDesc = sentences[0] || title;
    }
    // 去除角色描述末尾多餘的稱謂詞（如「的」或頓號）
    roleDesc = roleDesc.replace(/[的、]?$|^報導/, "").trim();
    // 構造輸出行：姓名｜標籤｜來源｜描述
    results.push(`${fullName}｜${tag}｜${sourceName}｜${roleDesc}`);
  }
  return results;
}

// 輔助函式：去除字串中的HTML標籤
function stripHtml(html) {
  // 利用瀏覽器 DOM 解析移除HTML標籤
  let doc = new DOMParser().parseFromString(html, 'text/html');
  return doc.body.textContent || "";
}

// 將結果陣列即時附加到頁面顯示
function appendResults(lines) {
  const resultsPre = document.getElementById('results');
  lines.forEach(line => {
    resultsPre.textContent += line + "\n";
  });
}

// 將結果資料下載為txt檔
function downloadResults(lines) {
  const blob = new Blob([lines.join("\n")], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'news_names.txt';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>純前端 Google 新聞人名擷取工具</title>
</head>
<body>
<h1>Google 新聞人名擷取工具</h1>
<div>
  <label for="timeRange">新聞時間範圍：</label>
  <select id="timeRange">
    <option value="1">最近一天</option>
    <option value="7" selected>最近一週</option>
    <option value="30">最近一月</option>
  </select>
</div>
<div>
  <label for="maxCount">最大新聞數量：</label>
  <input type="number" id="maxCount" value="100" min="1" max="200">
</div>
<button id="startBtn">開始爬取</button>
<p id="message" style="white-space: pre-wrap;"></p>
<script>
document.getElementById('startBtn').addEventListener('click', async function() {
  const timeRange = document.getElementById('timeRange').value;
  const maxCount = parseInt(document.getElementById('maxCount').value) || 0;
  const messageEl = document.getElementById('message');
  // 簡單驗證輸入
  if (maxCount <= 0) {
    messageEl.style.color = 'red';
    messageEl.textContent = '請輸入有效的新聞數量（至少1）。';
    return;
  }
  // 停用輸入欄位與按鈕
  document.getElementById('startBtn').disabled = true;
  document.getElementById('timeRange').disabled = true;
  document.getElementById('maxCount').disabled = true;
  messageEl.style.color = 'black';
  messageEl.textContent = '正在爬取新聞，請稍候...';
  try {
    const query = '台灣主流媒體新聞';
    // 加入時間範圍過濾參數（例如 when:7d 表示7天內新聞）
    const days = parseInt(timeRange);
    const queryParam = days ? encodeURIComponent(query + ' when:' + days + 'd') : encodeURIComponent(query);
    const url = 'https://news.google.com/rss/search?q=' + queryParam + '&hl=zh-TW&gl=TW&ceid=TW:zh-Hant';
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    const rssText = await response.text();
    // 移除 <media:...> 相關標籤以簡化 XML 解析
    const cleanedRss = rssText.replace(/<\/?media:.*?>/g, '');
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(cleanedRss, 'text/xml');
    const parseError = xmlDoc.getElementsByTagName('parsererror');
    if (parseError.length > 0) {
      throw new Error('Parser error');
    }
    const items = xmlDoc.getElementsByTagName('item');
    if (items.length === 0) {
      messageEl.style.color = 'red';
      messageEl.textContent = '找不到任何新聞結果。';
      return;
    }
    const nameSet = new Set();
    const now = Date.now();
    let processedCount = 0;
    const timeThreshold = now - days * 24 * 60 * 60 * 1000;
    for (let i = 0; i < items.length; i++) {
      if (processedCount >= maxCount) break;
      const item = items[i];
      const pubDateNode = item.getElementsByTagName('pubDate')[0];
      if (pubDateNode) {
        const pubDate = new Date(pubDateNode.textContent);
        if (days && pubDate.getTime() < timeThreshold) {
          // 跳過超出時間範圍的舊新聞
          continue;
        }
      }
      processedCount++;
      // 從 description 中取得新聞摘要（第一個 <p> 的文字）
      let snippetText = '';
      const descNode = item.getElementsByTagName('description')[0];
      if (descNode) {
        const pNode = descNode.getElementsByTagName('p')[0];
        if (pNode) {
          snippetText = pNode.textContent;
        } else {
          snippetText = descNode.textContent || '';
        }
      }
      // 使用正則表達式尋找「中文姓名（括號備註）」格式的字串
      const namePattern = /[\u3400-\u4DBF\u4E00-\u9FFF]{2,4}（[^）]{2,}）/g;
      const matches = snippetText.matchAll(namePattern);
      for (const match of matches) {
        let nameStr = match[0];
        // 避免藝名：如果括號內容以「本名」起頭，則取代為真實姓名在前（例：「小甜甜（本名張可昀）」→「張可昀（小甜甜）」）
        const noteContent = nameStr.substring(nameStr.indexOf('（') + 1, nameStr.length - 1);
        if (noteContent.startsWith('本名')) {
          const realName = noteContent.substring(2); // 去除「本名」
          const nickName = nameStr.substring(0, nameStr.indexOf('（'));
          nameStr = realName + '（' + nickName + '）';
        }
        nameSet.add(nameStr);
      }
    }
    if (processedCount === 0) {
      messageEl.style.color = 'red';
      messageEl.textContent = '指定時間範圍內沒有找到新聞。';
    } else if (nameSet.size === 0) {
      messageEl.style.color = 'red';
      messageEl.textContent = '未從新聞內容中擷取到人名。';
    } else {
      // 生成純文字檔案並觸發下載
      let content = '';
      nameSet.forEach(name => {
        content += name + '\n';
      });
      const blob = new Blob([content], { type: 'text/plain' });
      const blobUrl = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = blobUrl;
      a.download = 'names.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(blobUrl);
      messageEl.style.color = 'green';
      messageEl.textContent = '完成！已下載人名列表.txt';
    }
  } catch (error) {
    console.error(error);
    messageEl.style.color = 'red';
    messageEl.textContent = '發生錯誤：無法取得新聞資料。';
  } finally {
    // 恢復可輸入狀態
    document.getElementById('startBtn').disabled = false;
    document.getElementById('timeRange').disabled = false;
    document.getElementById('maxCount').disabled = false;
  }
});
</script>
</body>
</html>

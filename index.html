<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>新聞人物名稱爬蟲</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
label { margin-right: 10px; }
input, select { margin: 5px 10px 5px 0; }
#progress-container { width: 100%; background: #eee; border: 1px solid #ccc; height: 20px; margin-top: 10px; }
#progress-bar { background: #4caf50; height: 100%; width: 0%; }
#progress-text { font-size: 14px; margin-top: 5px; }
#result { margin-top: 20px; white-space: pre-line; }
</style>
</head>
<body>
<h1>新聞人物姓名萃取工具</h1>
<div>
  <label for="timeRange">新聞時間範圍:</label>
  <select id="timeRange">
    <option value="today">今天</option>
    <option value="3days">近三日</option>
    <option value="week">一週內</option>
  </select>
</div>
<div>
  <label for="maxCount">最大新聞篇數:</label>
  <input type="number" id="maxCount" value="50" min="1" />
</div>
<div>
  <label for="delay">每篇延遲(秒):</label>
  <input type="number" id="delay" value="1" min="0" />
</div>
<button id="startBtn">開始爬取</button>
<div id="progress-text"></div>
<div id="progress-container"><div id="progress-bar"></div></div>
<button id="downloadBtn" style="display:none;">下載結果</button>
<pre id="result"></pre>

<script>
async function fetchText(url) {
  const response = await fetch(url);
  if (!response.ok) throw new Error("Network response was not ok");
  return await response.text();
}
function parseDateFromText(dateStr) {
  // 將日期字串轉為 Date 物件
  if (dateStr.includes('/')) {
    // 假設格式為 YYYY/MM/DD HH:MM
    const [datePart, timePart] = dateStr.split(' ');
    const [year, month, day] = datePart.split('/').map(Number);
    const [hour, minute] = timePart ? timePart.split(':').map(Number) : [0, 0];
    return new Date(year, month - 1, day, hour, minute);
  }
  const d = new Date(dateStr);
  return isNaN(d) ? null : d;
}
function extractNamesFromText(text) {
  const surnames = [
    // 常見中文姓氏 + 常見複姓
    "王","李","張","劉","陳","楊","黃","吳","趙","周","徐","孫","馬","朱","胡","林","郭",
    "何","高","羅","鄭","梁","謝","宋","唐","許","韓","馮","鄧","曹","彭","曾","蕭","田",
    "董","潘","袁","蔡","蔣","余","於","杜","葉","程","魏","蘇","呂","丁","任","沈","姚",
    "盧","姜","崔","鍾","譚","陸","汪","范","金","石","廖","賈","夏","韋","傅","方","白",
    "邱","孟","熊","秦","薛","江","龍","段","雷","侯","萬","錢","湯","尹","黎","易","常",
    "武","喬","賀","賴","龔","文",
    "歐陽","司馬","上官","諸葛","夏侯","慕容","尉遲","東方","赫連",
    // 外國人名常見譯名的姓開頭（選幾例常見的）
    "川","拜","普","梅","默","安","馬克","約","華"
  ];
  const nameSet = new Set();
  const regex = /[\u4e00-\u9fff]{2,3}/g;
  let match;
  while ((match = regex.exec(text)) !== null) {
    const name = match[0];
    // 排除「X男」「X女」這類姓氏+性別代稱的非全名
    if (name.length === 2 && (name[1] === "男" || name[1] === "女")) continue;
    // 必須以常見姓氏或譯名開頭
    let hasSurname = false;
    for (const surname of surnames) {
      if (name.startsWith(surname)) { hasSurname = true; break; }
    }
    if (!hasSurname) continue;
    nameSet.add(name);
  }
  return Array.from(nameSet);
}
document.getElementById('startBtn').addEventListener('click', async () => {
  const timeRange = document.getElementById('timeRange').value;
  const maxCount = parseInt(document.getElementById('maxCount').value) || 1;
  const delaySec = parseFloat(document.getElementById('delay').value) || 0;
  const delayMs = delaySec * 1000;
  const now = new Date();
  let cutoff;
  if (timeRange === 'today') {
    cutoff = new Date();
    cutoff.setHours(0, 0, 0, 0);
  } else if (timeRange === '3days') {
    cutoff = new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000);
  } else if (timeRange === 'week') {
    cutoff = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
  } else {
    cutoff = new Date(0);
  }
  const articleList = [];
  // Source 1: 自由時報
  try {
    const ltnXml = await fetchText('https://api.allorigins.win/raw?url=' + encodeURIComponent('https://news.ltn.com.tw/rss/all.xml'));
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(ltnXml, 'application/xml');
    const items = Array.from(xmlDoc.getElementsByTagName('item'));
    for (let item of items) {
      const link = item.getElementsByTagName('link')[0]?.textContent;
      const pubDateStr = item.getElementsByTagName('pubDate')[0]?.textContent;
      if (!link || !pubDateStr) continue;
      const pubDate = new Date(pubDateStr);
      if (isNaN(pubDate) || pubDate < cutoff) continue;
      articleList.push({ link: link, source: "自由時報", date: pubDate });
    }
  } catch (e) {
    console.error("LTN RSS fetch error:", e);
  }
  // Source 2: 聯合報 (UDN 即時綜合)
  try {
    const udnXml = await fetchText('https://api.allorigins.win/raw?url=' + encodeURIComponent('https://rsshub.app/udn/news/breakingnews/99'));
    const parser2 = new DOMParser();
    const xmlDoc2 = parser2.parseFromString(udnXml, 'application/xml');
    const items2 = Array.from(xmlDoc2.getElementsByTagName('item'));
    for (let item of items2) {
      const link = item.getElementsByTagName('link')[0]?.textContent;
      const pubDateStr = item.getElementsByTagName('pubDate')[0]?.textContent;
      if (!link || !pubDateStr) continue;
      const pubDate = new Date(pubDateStr);
      if (isNaN(pubDate) || pubDate < cutoff) continue;
      articleList.push({ link: link, source: "聯合報", date: pubDate });
    }
  } catch (e) {
    console.error("UDN RSS fetch error:", e);
  }
  // Source 3: 蘋果新聞網 (NextApple)
  try {
    const appleXml = await fetchText('https://api.allorigins.win/raw?url=' + encodeURIComponent('https://rsshub.app/nextapple/realtime/latest'));
    const parser3 = new DOMParser();
    const xmlDoc3 = parser3.parseFromString(appleXml, 'application/xml');
    const items3 = Array.from(xmlDoc3.getElementsByTagName('item'));
    for (let item of items3) {
      const link = item.getElementsByTagName('link')[0]?.textContent;
      const pubDateStr = item.getElementsByTagName('pubDate')[0]?.textContent;
      if (!link || !pubDateStr) continue;
      const pubDate = new Date(pubDateStr);
      if (isNaN(pubDate) || pubDate < cutoff) continue;
      articleList.push({ link: link, source: "蘋果新聞網", date: pubDate });
    }
  } catch (e) {
    console.error("NextApple RSS fetch error:", e);
  }
  // Source 4: TVBS新聞
  try {
    const tvbsHtmlText = await fetchText('https://api.allorigins.win/raw?url=' + encodeURIComponent('https://news.tvbs.com.tw'));
    const parser4 = new DOMParser();
    const tvbsDoc = parser4.parseFromString(tvbsHtmlText, 'text/html');
    const liElements = tvbsDoc.querySelectorAll('li');
    const datePattern = /\d{4}\/\d{2}\/\d{2}\s+\d{2}:\d{2}/;
    liElements.forEach(li => {
      const spans = li.querySelectorAll('span');
      spans.forEach(span => {
        const dateText = span.textContent.trim();
        if (datePattern.test(dateText)) {
          const pubDate = parseDateFromText(dateText);
          if (!pubDate || pubDate < cutoff) return;
          const a = li.querySelector('a[href]');
          if (a) {
            let link = a.getAttribute('href');
            if (link && !link.startsWith('http')) {
              link = 'https://news.tvbs.com.tw' + link;
            }
            articleList.push({ link: link, source: "TVBS", date: pubDate });
          }
        }
      });
    });
  } catch (e) {
    console.error("TVBS fetch error:", e);
  }
  if (articleList.length === 0) {
    document.getElementById('progress-text').innerText = "查無相關新聞";
    return;
  }
  // 按時間由近至遠排序，取最多maxCount篇
  articleList.sort((a, b) => b.date - a.date);
  if (articleList.length > maxCount) {
    articleList.length = maxCount;
  }
  // 順序抓取每篇文章
  const total = articleList.length;
  const namesWithSource = [];
  for (let i = 0; i < total; i++) {
    const { link, source } = articleList[i];
    try {
      const articleHtml = await fetchText('https://api.allorigins.win/raw?url=' + encodeURIComponent(link));
      const textContent = articleHtml.replace(/<\/?.+?>/g, ' ');  // 去除HTML標籤，只保留文字
      const names = extractNamesFromText(textContent);
      for (let name of names) {
        namesWithSource.push(name + "（" + source + "）");
      }
    } catch (e) {
      console.error("Article fetch error:", link, e);
    }
    // 更新進度條和百分比
    const percent = (((i + 1) / total) * 100).toFixed(2) + "%";
    document.getElementById('progress-bar').style.width = percent;
    document.getElementById('progress-text').innerText = "進度 " + (i + 1) + "/" + total + " (" + percent + ")";
    // 延遲
    await new Promise(res => setTimeout(res, delayMs));
  }
  if (namesWithSource.length === 0) {
    document.getElementById('result').innerText = "查無人物姓名";
  } else {
    document.getElementById('result').innerText = namesWithSource.join("\\n");
  }
  // 準備下載檔案
  const blob = new Blob([namesWithSource.join("\\n")], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const downloadBtn = document.getElementById('downloadBtn');
  downloadBtn.href = url;
  downloadBtn.download = "names.txt";
  downloadBtn.style.display = "inline";
});
</script>
</body>
</html>

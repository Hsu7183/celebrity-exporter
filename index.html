<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>新聞人名爬蟲工具</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  label { font-weight: bold; margin-right: 5px; }
  select, input { margin-bottom: 10px; }
  #progress-container { margin-top: 20px; }
  #progress-bar { width: 100%; height: 20px; }
  #errorLog { color: red; white-space: pre-wrap; margin-top: 10px; }
</style>
</head>
<body>
<h1>台灣新聞人名爬蟲工具</h1>
<div>
  <label for="timeRange">新聞時間區間：</label>
  <select id="timeRange">
    <option value="1d">今日</option>
    <option value="3d">近三天</option>
    <option value="7d">近一週</option>
    <option value="1m">近一個月</option>
  </select>
</div>
<div>
  <label for="maxResults">最大搜尋新聞數量：</label>
  <input type="number" id="maxResults" min="1" max="300" value="50"> 篇
</div>
<div>
  <label for="delaySeconds">每則延遲秒數：</label>
  <input type="number" id="delaySeconds" min="0" max="5" value="1"> 秒
</div>
<button id="startBtn">開始爬取</button>
<div id="progress-container">
  <progress id="progressBar" value="0" max="100"></progress>
  <span id="progressText">0.00%</span>
</div>
<div id="errorLog"></div>
<a id="downloadLink" style="display:none;"></a>
<script>
// 常見單字姓氏列表（節選常見姓氏508個）
const singleSurnames = ["赵","钱","孙","李","周","吴","郑","王","冯","陈","褚","卫","蒋","沈","韩","杨","朱","秦","尤","许","何","吕","施","张","孔","曹","严","华","金","魏","陶","姜","戚","谢","邹","喻","柏","水","窦","章","云","苏","潘","葛","奚","范","彭","郎","鲁","韦","昌","马","苗","凤","花","方","俞","任","袁","柳","酆","鲍","史","唐","费","廉","岑","薛","雷","贺","倪","汤","滕","殷","罗","毕","郝","邬","安","常","乐","于","时","傅","皮","卞","齐","康","伍","余","元","卜","顾","孟","平","黄","和","穆","萧","尹","姚","邵","湛","汪","祁","毛","禹","狄","米","贝","明","臧","计","伏","成","戴","谈","宋","茅","庞","熊","纪","舒","屈","项","祝","董","梁","杜","阮","蓝","闵","席","季","麻","强","贾","路","娄","危","江","童","颜","郭","梅","盛","林","刁","钟","徐","邱","骆","高","夏","蔡","田","樊","胡","凌","霍","虞","万","支","柯","昝","管","卢","莫","经","房","裘","缪","干","解","应","宗","丁","宣","贲","邓","郁","单","杭","洪","包","诸","左","石","崔","吉","钮","龚","程","嵇","邢","滑","裴","陆","荣","翁","荀","羊","於","惠","甄","麴","家","封","芮","羿","储","靳","汲","邴","糜","松","井","段","富","巫","乌","焦","巴","弓","牧","隗","山","谷","车","侯","宓","蓬","全","郗","班","仰","秋","仲","伊","宫","宁","仇","栾","暴","甘","钭","厉","戎","祖","武","符","刘","景","詹","束","龙","叶","幸","司","韶","郜","黎","蓟","薄","印","宿","白","怀","蒲","邰","从","鄂","索","咸","籍","赖","卓","蔺","屠","蒙","池","乔","阴","欎","胥","能","苍","双","闻","莘","党","翟","谭","贡","劳","逄","姬","申","扶","堵","冉","宰","郦","雍","舄","璩","桑","桂","濮","牛","寿","通","边","扈","燕","冀","郏","浦","尚","农","温","别","庄","晏","柴","瞿","阎","充","慕","连","茹","习","宦","艾","鱼","容","向","古","易","慎","戈","廖","庾","终","暨","居","衡","步","都","耿","满","弘","匡","国","文","寇","广","禄","阙","东","殴","殳","沃","利","蔚","越","夔","隆","师","巩","厍","聂","晁","勾","敖","融","冷","訾","辛","阚","那","简","饶","空","曾","毋","沙","乜","养","鞠","须","丰","巢","关","蒯","相","查","後","荆","红","游","竺","权","逯","盖","益","桓","公","仉","督","盖","逯","库","郏","逢","阴","薄","厉","稽"];  // 略去部分罕見姓氏
// 常見複姓列表（兩字姓，共約60個）
const multiSurnames = ["万俟","司马","上官","欧阳","夏侯","诸葛","闻人","东方","赫连","皇甫","尉迟","公羊","澹台","公冶","宗政","濮阳","淳于","单于","太叔","申屠","公孙","仲孙","轩辕","令狐","钟离","宇文","长孙","慕容","鲜于","闾丘","司徒","司空","亓官","司寇","子车","颛孙","端木","巫马","公西","漆雕","乐正","壤驷","公良","拓跋","夹谷","宰父","谷梁","段干","百里","东郭","南门","呼延","归海","羊舌","微生","南宫","墨","南宫","赏","伯","佴","佘","佟","第五","言","福"];
const surnameSet = new Set(singleSurnames);
const multiSurnameSet = new Set(multiSurnames);

// 通用函式：使用 AllOrigins 代理抓取文本內容
async function fetchText(url) {
  const response = await fetch("https://api.allorigins.win/raw?url=" + encodeURIComponent(url));
  if (!response.ok) {
    throw new Error(response.status + " " + response.statusText);
  }
  return await response.text();
}

// 從給定文字中提取中文姓名的函式
function extractNamesFromText(text) {
  const namesFound = new Set();
  const len = text.length;
  for (let i = 0; i < len; i++) {
    const ch = text[i];
    if (!ch.match(/[\u4e00-\u9fff]/)) continue;  // 非中文字符跳過
    // 檢查兩字姓
    if (i < len - 1) {
      const twoChars = text.substr(i, 2);
      if (multiSurnameSet.has(twoChars)) {
        const surname = twoChars;
        let j = i + 2;
        if (j < len && /[\u4e00-\u9fff]/.test(text[j])) {
          // 姓名：複姓 + 單名
          namesFound.add(surname + text[j]);
          if (j + 1 < len && /[\u4e00-\u9fff]/.test(text[j+1])) {
            // 姓名：複姓 + 雙名
            namesFound.add(surname + text[j] + text[j+1]);
          }
        }
        i += surname.length - 1;  // 跳過複姓的第二字，避免重覆處理
        continue;
      }
    }
    // 檢查單字姓
    if (surnameSet.has(ch)) {
      const surname = ch;
      if (i + 1 < len && /[\u4e00-\u9fff]/.test(text[i+1])) {
        // 姓名：單姓 + 單名
        namesFound.add(surname + text[i+1]);
        if (i + 2 < len && /[\u4e00-\u9fff]/.test(text[i+2])) {
          // 姓名：單姓 + 雙名
          namesFound.add(surname + text[i+1] + text[i+2]);
        }
      }
    }
  }
  // 過濾掉包含語助詞/虛詞的非姓名組合
  const invalidChars = new Set(['的','了','著','嗎','嘛','吗','吧','呢','啊','呀','麼','么','是','及','與','与']);
  const finalNames = [];
  for (let name of namesFound) {
    if (name.length < 2) continue;
    let drop = false;
    for (let k = 1; k < name.length; k++) {
      if (invalidChars.has(name[k])) {  // 若姓名中（除姓氏外）包含無意義字詞，則視為非姓名
        drop = true;
        break;
      }
    }
    if (!drop) {
      finalNames.push(name);
    }
  }
  return finalNames;
}

// 綁定開始按鈕事件
document.getElementById('startBtn').addEventListener('click', async () => {
  const timeRange = document.getElementById('timeRange').value;
  let maxResults = parseInt(document.getElementById('maxResults').value) || 0;
  const delay = parseInt(document.getElementById('delaySeconds').value) || 0;
  if (maxResults > 300) maxResults = 300;
  // 重置進度和錯誤訊息
  document.getElementById('errorLog').textContent = '';
  document.getElementById('progressBar').value = 0;
  document.getElementById('progressText').textContent = '0.00%';
  // 準備 Google 新聞 RSS 查詢 URL
  const siteList = [
    'ettoday.net','ltn.com.tw','udn.com','tvbs.com.tw','setn.com',
    'ebc.net.tw','ctinews.com','chinatimes.com','ftvnews.com.tw','yahoo.com'
  ];
  let feedUrls = [];
  if (maxResults <= 100) {
    // 條目數少於等於100則透過單一複合查詢
    const query = '(' + siteList.map(s => 'site:' + s).join(' OR ') + ') when:' + timeRange;
    feedUrls.push('https://news.google.com/rss/search?hl=zh-TW&gl=TW&ceid=TW:zh-Hant&q=' + encodeURIComponent(query));
  } else {
    // 條目數較多則逐一以站點為單位查詢（彌補 Google RSS 每次最多100篇的限制）
    for (let site of siteList) {
      const query = 'site:' + site + ' when:' + timeRange;
      feedUrls.push('https://news.google.com/rss/search?hl=zh-TW&gl=TW&ceid=TW:zh-Hant&q=' + encodeURIComponent(query));
    }
  }
  try {
    // 抓取所有RSS結果並彙總新聞項目
    const allItems = [];
    for (let feedUrl of feedUrls) {
      const rssText = await fetchText(feedUrl);
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(rssText, 'text/xml');
      const items = xmlDoc.querySelectorAll('item');
      items.forEach(item => {
        const link = item.querySelector('link').textContent;
        const sourceElem = item.querySelector('source');
        const sourceName = sourceElem ? sourceElem.textContent.trim() : '';
        allItems.push({ link: link, source: sourceName });
      });
    }
    // 過濾重覆的新聞連結（避免同一新聞多次出現）
    const uniqueItems = [];
    const seenLinks = new Set();
    for (let it of allItems) {
      if (seenLinks.has(it.link)) continue;
      seenLinks.add(it.link);
      uniqueItems.push(it);
      if (uniqueItems.length >= maxResults) break;
    }
    const totalItems = uniqueItems.length;
    if (totalItems === 0) {
      alert('找不到任何新聞，請嘗試不同的時間區間或條件。');
      return;
    }
    // 逐篇抓取新聞內容並提取人名
    let resultLines = [];
    let completed = 0;
    for (let item of uniqueItems) {
      try {
        const articleHtml = await fetchText(item.link);
        const parser = new DOMParser();
        const doc = parser.parseFromString(articleHtml, 'text/html');
        // 移除腳本和樣式以免干擾
        doc.querySelectorAll('script, style').forEach(el => el.remove());
        const textContent = doc.body ? doc.body.innerText || '' : '';
        const names = extractNamesFromText(textContent);
        const uniqueNames = new Set(names);
        uniqueNames.forEach(name => {
          if (name.length > 1) {
            const sourceLabel = item.source || '';
            // 每行輸出格式：姓名 (來源媒體)
            resultLines.push(name + (sourceLabel ? ' (' + sourceLabel + ')' : ''));
          }
        });
      } catch (err) {
        document.getElementById('errorLog').textContent += '新聞擷取失敗: ' + item.link + ' (' + err.message + ')\\n';
      }
      completed++;
      const percent = (completed / totalItems) * 100;
      document.getElementById('progressBar').value = percent;
      document.getElementById('progressText').textContent = percent.toFixed(2) + '%';
      if (delay > 0) {
        // 延遲指定秒數再進行下一次請求
        await new Promise(res => setTimeout(res, delay * 1000));
      }
    }
    if (resultLines.length === 0) {
      alert('已完成爬取，但未提取到任何姓名。');
    } else {
      // 建立檔案 Blob 並觸發下載
      const blob = new Blob([resultLines.join('\\n')], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const downloadLink = document.getElementById('downloadLink');
      downloadLink.href = url;
      downloadLink.download = 'names.txt';
      downloadLink.textContent = '下載 names.txt';
      downloadLink.style.display = 'inline';
      downloadLink.click();  // 自動觸發下載
    }
  } catch (err) {
    document.getElementById('errorLog').textContent = '發生錯誤：' + err.message;
  }
});
</script>
</body>
</html>

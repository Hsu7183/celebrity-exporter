<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>新聞RSS人名擷取工具</title>
<style>
  body { font-family: sans-serif; line-height: 1.6; margin: 2em; }
  h1 { font-size: 1.5em; }
  .controls { background: #f9f9f9; padding: 1em; border: 1px solid #ccc; }
  .controls label { display: block; margin: 0.5em 0 0.2em; }
  .controls input[type="number"] { width: 5em; }
  .results { margin-top: 1.5em; white-space: pre-wrap; font-family: monospace; }
  .hidden { display: none; }
</style>
</head>
<body>

<h1>新聞 RSS 人名擷取工具</h1>
<div class="controls">
  <label><input type="checkbox" id="src-ltn" checked> 自由時報 (RSS 即時新聞)</label>
  <label><input type="checkbox" id="src-et" checked> ETtoday 新聞雲 (RSS 即時新聞)</label>
  <label>擷取每個來源最新 
    <input type="number" id="newsCount" value="5" min="1" max="50"> 則新聞
  </label>
  <label>爬取間隔秒數 
    <input type="number" id="delaySec" value="2" min="0" max="10"> 秒
  </label>
  <label>分類關鍵字清單 (逗號或換行分隔)：<br>
    <textarea id="categoryKeywords" rows="2" style="width:100%;">女警, 藝人, 啦啦隊員, 網紅, 模特兒, 政治人物</textarea>
  </label>
  <button id="startBtn">開始擷取</button>
  <button id="downloadBtn" disabled>下載結果 TXT</button>
</div>

<pre id="output" class="results"></pre>

<script>
(async function(){
  // 常見中文姓氏列表 (單姓)
  const surnames1 = [
    "李","王","張","劉","陳","楊","黃","趙","周","吳","徐","孫","朱","馬","胡","郭","林","何","高","梁",
    "鄭","羅","宋","謝","唐","韓","曹","許","鄧","蕭","馮","曾","程","蔡","彭","潘","袁","于","董","余",
    "蘇","葉","呂","魏","蔣","田","杜","丁","沈","姜","范","江","傅","鐘","盧","汪","戴","崔","任","陸",
    "廖","姚","方","金","邱","夏","譚","韋","賈","鄒","石","熊","孟","秦","閻","薛","侯","雷","白","龍",
    "段","郝","孔","邵","史","毛","常","萬","顧","賴","武","康","賀","嚴","尹","錢","施","牛","洪","龔"
  ];
  // 常見複姓列表 (雙字姓氏)
  const surnames2 = [
    "歐陽","司馬","上官","夏侯","諸葛","東方","皇甫","段常","南宮","司徒","司空","章佳","那拉",
    "張簡","范姜","張廖","歐陽", "范姜" // （包含一些台灣常見複姓）
  ];
  // Helper: 檢查字符串是否為可能的人名（長度2或3，且符合姓氏規則）
  function isLikelyName(str) {
    const len = str.length;
    if (len < 2 || len > 3) return false;
    if (len === 2) {
      // 2字：第一字是常見姓氏即可
      return surnames1.includes(str[0]);
    } else if (len === 3) {
      // 3字：前兩字是複姓 或 第一字是單姓
      const firstTwo = str.substring(0, 2);
      if (surnames2.includes(firstTwo)) return true;
      // 或第一字為單姓且後兩字不全為某些避開字
      return surnames1.includes(str[0]);
    }
    return false;
  }
  // Helper: 判斷周邊文本是否有分類關鍵字，傳回找到的標籤或空字串
  function getCategoryForName(name, text, categories) {
    // 在全文中找該名字的位置，逐一判斷
    let label = "";
    let idx = 0;
    while ((idx = text.indexOf(name, idx)) !== -1) {
      // 找出該名字所在句子的片段 (從前一個句號或開頭，到下一個句號或段落)
      let start = text.lastIndexOf('。', idx);
      let end = text.indexOf('。', idx);
      if (start === -1) start = 0; else start += 1;
      if (end === -1) end = text.length;
      const sentence = text.slice(start, end);
      // 檢查此句子是否包含分類關鍵詞
      for (let [keyword, catLabel] of categories) {
        if (sentence.includes(keyword)) {
          label = catLabel;
          break;
        }
      }
      if (label) break;
      idx += name.length; // 繼續搜尋下一處
    }
    return label;
  }
  // Helper: 判斷名稱是否為筆名/綽號 (根據上下文)
  function checkAlias(name, text) {
    let isAlias = false;
    let aliasType = "";
    // 檢查名字後面是否緊跟(化名/筆名/綽號)
    const after = text.indexOf(name + "（", 0);
    if (after !== -1) {
      const seg = text.substring(after, after + name.length + 4);
      if (seg.includes("（化名")) { isAlias = true; aliasType = "化名"; }
      else if (seg.includes("（筆名")) { isAlias = true; aliasType = "筆名"; }
      else if (seg.includes("（綽號")) { isAlias = true; aliasType = "綽號"; }
    }
    // 檢查名字前面是否提到綽號/暱稱
    if (!isAlias) {
      const beforeIdx = text.indexOf(name);
      if (beforeIdx !== -1) {
        const beforeSeg = text.slice(Math.max(0, beforeIdx-3), beforeIdx);
        if (beforeSeg.includes("綽號") || beforeSeg.includes("暱稱")) {
          isAlias = true;
          aliasType = "綽號";
        }
      }
    }
    return isAlias ? aliasType || "化名" : "";
  }

  // 綁定按鈕事件
  document.getElementById('startBtn').onclick = async function() {
    const useLtn = document.getElementById('src-ltn').checked;
    const useEt = document.getElementById('src-et').checked;
    const count = parseInt(document.getElementById('newsCount').value, 10) || 1;
    const delaySec = parseFloat(document.getElementById('delaySec').value) || 0;
    // 解析關鍵字清單
    const catsInput = document.getElementById('categoryKeywords').value;
    let categories = [];
    catsInput.split(/[,，\n]/).forEach(kw => {
      const k = kw.trim();
      if (k) categories.push([k, k]); // 目前關鍵字即標籤名稱
    });
    const output = document.getElementById('output');
    output.textContent = "擷取中，請稍候...\n";
    document.getElementById('downloadBtn').disabled = true;

    // 來源RSS URLs
    const feeds = [];
    if (useLtn) feeds.push({ name: "自由時報", url: "https://news.ltn.com.tw/rss/all.xml" });
    if (useEt) feeds.push({ name: "ETtoday", url: "http://feeds.feedburner.com/ettoday/newslist" });
    const parser = new DOMParser();
    const results = [];  // {name, label, source} objects

    for (let feed of feeds) {
      try {
        const res = await fetch(feed.url);
        if (!res.ok) throw new Error(`取得 ${feed.name} RSS 失敗: ${res.status}`);
        const rssText = await res.text();
        const xmlDoc = parser.parseFromString(rssText, "text/xml");
        const items = Array.from(xmlDoc.getElementsByTagName("item"));
        for (let i = 0; i < Math.min(count, items.length); i++) {
          const item = items[i];
          // 取得文章連結
          let link = item.getElementsByTagName("link")[0]?.textContent;
          if (!link) {
            // RSS可能使用 guid
            link = item.getElementsByTagName("guid")[0]?.textContent || "";
          }
          if (!link) continue;
          // 抓取文章內容
          try {
            const artRes = await fetch(link);
            if (!artRes.ok) throw new Error(`${artRes.status}`);
            const htmlText = await artRes.text();
            const doc = parser.parseFromString(htmlText, "text/html");
            const bodyText = doc.body ? doc.body.innerText : "";
            if (!bodyText) continue;
            // 尋找人名候選
            const candidates = bodyText.match(/[\u4e00-\u9fff]{2,3}/g) || [];
            const seenNames = new Set();
            for (let cand of candidates) {
              if (seenNames.has(cand)) continue;
              seenNames.add(cand);
              if (!isLikelyName(cand)) continue;
              // 排除特殊稱謂 (如 張某、李男 等)
              const secondChar = cand[1];
              if (secondChar === "某" || secondChar === "男" || secondChar === "女" || secondChar === "姓") {
                continue;
              }
              // 判斷分類標籤
              let label = getCategoryForName(cand, bodyText, categories);
              // 判斷是否筆名/綽號
              const aliasType = checkAlias(cand, bodyText);
              if (aliasType) {
                // 如果該名字本身沒有分類標籤，可能是一個暱稱，仍然保留但註記
                if (!label) label = "（" + aliasType + "）"; 
                else label += "(" + aliasType + ")";
              }
              // 保存結果
              results.push({ name: cand, label: label || "", source: feed.name });
            }
          } catch (err) {
            console.warn(`無法擷取 ${feed.name} 文章內容: ${link}`, err);
          }
          // 間隔延遲
          if (delaySec > 0 && i < Math.min(count, items.length) - 1) {
            await new Promise(r => setTimeout(r, delaySec * 1000));
          }
        } // end for each item
      } catch (err) {
        console.error(`抓取 ${feed.name} RSS 時發生錯誤:`, err);
      }
    } // end for each feed

    if (results.length === 0) {
      output.textContent += "未擷取到任何人名。";
    } else {
      // 移除重複項目（同姓名同來源重複則去重）
      const uniqueSet = new Set();
      const lines = [];
      for (let item of results) {
        const key = item.name + "|" + item.label + "|" + item.source;
        if (uniqueSet.has(key)) continue;
        uniqueSet.add(key);
        lines.push(`${item.name}｜${item.label || " "}｜${item.source}`);
      }
      // 輸出結果
      output.textContent = lines.join("\n");
      // 啟用下載按鈕
      document.getElementById('downloadBtn').disabled = false;
    }
  };

  // 下載 TXT 功能
  document.getElementById('downloadBtn').onclick = function() {
    const text = document.getElementById('output').textContent;
    const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "names.txt";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };
})();
</script>

</body>
</html>
